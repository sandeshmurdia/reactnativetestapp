var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _axios=_interopRequireDefault(require("axios"));var _Init=require("./Init");var _constants=require("../utils/constants");var _ApiCall=_interopRequireDefault(require("../utils/ApiCall"));var _asyncStorage=_interopRequireDefault(require("@react-native-async-storage/async-storage"));var _helper=require("../utils/helper");var AxiosInterceptor=function AxiosInterceptor(configData){var axiosInstance=_axios.default.create(configData);axiosInstance.interceptors.request.use(function(config){return config;});var logNetworkRequests=function logNetworkRequests(response){var _response$config,_response$config$url,_response$config2,_response$config2$url,_response$config3,_response$config3$url,_response$config4,_response$config4$url,_response$config5,_response$config5$url,_response$config6,_response$config6$url,_response$config7,_response$config7$url,_response$config8,_response$config8$url,_response$config9,_response$config9$url,_response$headers$con;var type="other";if(response!=null&&(_response$config=response.config)!=null&&(_response$config$url=_response$config.url)!=null&&_response$config$url.endsWith(".css")){type="css";}else if(response!=null&&(_response$config2=response.config)!=null&&(_response$config2$url=_response$config2.url)!=null&&_response$config2$url.endsWith(".js")){type="js";}else if(response!=null&&(_response$config3=response.config)!=null&&(_response$config3$url=_response$config3.url)!=null&&_response$config3$url.endsWith(".woff")||response!=null&&(_response$config4=response.config)!=null&&(_response$config4$url=_response$config4.url)!=null&&_response$config4$url.endsWith(".woff2")||response!=null&&(_response$config5=response.config)!=null&&(_response$config5$url=_response$config5.url)!=null&&_response$config5$url.endsWith(".ttf")){type="fonts";}else if(response!=null&&(_response$config6=response.config)!=null&&(_response$config6$url=_response$config6.url)!=null&&_response$config6$url.endsWith(".png")||response!=null&&(_response$config7=response.config)!=null&&(_response$config7$url=_response$config7.url)!=null&&_response$config7$url.endsWith(".jpg")||response!=null&&(_response$config8=response.config)!=null&&(_response$config8$url=_response$config8.url)!=null&&_response$config8$url.endsWith(".jpeg")||response!=null&&(_response$config9=response.config)!=null&&(_response$config9$url=_response$config9.url)!=null&&_response$config9$url.endsWith(".gif")){type="images";}else if(response!=null&&(_response$headers$con=response.headers["content-type"])!=null&&_response$headers$con.startsWith("application/json")){type="xhr";}return type;};axiosInstance.interceptors.response.use(function(){var _ref=(0,_asyncToGenerator2.default)(function*(response){try{var _response$request,_response$request2,_response$request3,_response$request4,_response$request5,_Object$values$,_response$request6,_response$request6$_p,_response$config10;var responseSize=response==null?void 0:(_response$request=response.request)==null?void 0:_response$request._response;eventAt=yield(0,_helper.formatTimestamp)(Date.now());var originalObject=response==null?void 0:response.headers;var objectWithNewlines={};for(var key in originalObject){if(originalObject.hasOwnProperty(key)){objectWithNewlines[key]=originalObject[key]+"\n";}}var responseheaderfinal=Object.entries(objectWithNewlines).map(function(_ref2){var _ref3=(0,_slicedToArray2.default)(_ref2,2),key=_ref3[0],value=_ref3[1];return`${key}: ${value}`;}).join('\n');var originalObjectrq=response==null?void 0:(_response$request2=response.request)==null?void 0:_response$request2._headers;var objectWithNewlinesrq={};for(var _key in originalObjectrq){if(originalObjectrq.hasOwnProperty(_key)){objectWithNewlinesrq[_key]=originalObjectrq[_key]+"\n";}}var reqheaderfinal=Object.entries(objectWithNewlinesrq).map(function(_ref4){var _ref5=(0,_slicedToArray2.default)(_ref4,2),key=_ref5[0],value=_ref5[1];return`${key}: ${value}`;}).join('\n');var reqData={eventType:_constants.NETWORKLOG,responseCode:response==null?void 0:response.status,requestMethod:response==null?void 0:(_response$request3=response.request)==null?void 0:_response$request3._method,requestUrl:response==null?void 0:(_response$request4=response.request)==null?void 0:_response$request4._url,requestType:logNetworkRequests(response),responseSize:`${responseSize.length} B`||`${response==null?void 0:(_response$request5=response.request)==null?void 0:_response$request5.responseHeaders["content-length"]} B`,responseTime:`${(_Object$values$=Object.values((_response$request6=response.request)==null?void 0:(_response$request6$_p=_response$request6._performanceLogger)==null?void 0:_response$request6$_p._timespans)[0])==null?void 0:_Object$values$.totalTime}`,responseHeader:responseheaderfinal,requestHeader:reqheaderfinal,eventAt:`${eventAt}`,createdAt:Date.now(),response:`${JSON.stringify(response==null?void 0:response.data)||""}`,request:`${(response==null?void 0:(_response$config10=response.config)==null?void 0:_response$config10.data)||""}`};var sessionid=yield _asyncStorage.default.getItem('session_id');var req_body={message:{key:_Init.api_key,sdk_ver:_constants.SDK_VERSION,src:_constants.SRC,src_tech_stack:_constants.TECH_STACK,events:reqData,'eu_info_id':'N/A','eue_id':'0','euz_id':'0','ip':'','rel_ver':'N/A','timezone':'IST',s_id:`${sessionid}`,event_type:_constants.MESSAGE}};yield(0,_ApiCall.default)(reqData,req_body);return response;}catch(error){console.error("Error in AxiosInterceptor response:",error);throw error;}});return function(_x){return _ref.apply(this,arguments);};}(),function(){var _ref6=(0,_asyncToGenerator2.default)(function*(error){var _error$response,_error$response$reque,_error$response2,_error$response3,_error$response3$requ,_error$response4,_error$response5,_error$response5$requ,_error$response6,_error$response6$requ,_error$response7,_error$response7$requ,_Object$values$2,_error$response$reque2,_error$response$reque3,_error$response8,_error$response9,_error$response9$conf;eventAt=yield(0,_helper.formatTimestamp)(Date.now());var sessionid=yield _asyncStorage.default.getItem('session_id');var responseSize=error==null?void 0:(_error$response=error.response)==null?void 0:(_error$response$reque=_error$response.request)==null?void 0:_error$response$reque._response;var originalObject=error==null?void 0:(_error$response2=error.response)==null?void 0:_error$response2.headers;var objectWithNewlines={};for(var key in originalObject){if(originalObject.hasOwnProperty(key)){objectWithNewlines[key]=originalObject[key]+"\n";}}var responseheaderfinal=Object.entries(objectWithNewlines).map(function(_ref7){var _ref8=(0,_slicedToArray2.default)(_ref7,2),key=_ref8[0],value=_ref8[1];return`${key}: ${value}`;}).join('\n');var originalObjectrq=error==null?void 0:(_error$response3=error.response)==null?void 0:(_error$response3$requ=_error$response3.request)==null?void 0:_error$response3$requ._headers;var objectWithNewlinesrq={};for(var _key2 in originalObjectrq){if(originalObjectrq.hasOwnProperty(_key2)){objectWithNewlinesrq[_key2]=originalObjectrq[_key2]+"\n";}}var reqheaderfinal=Object.entries(objectWithNewlinesrq).map(function(_ref9){var _ref10=(0,_slicedToArray2.default)(_ref9,2),key=_ref10[0],value=_ref10[1];return`${key}: ${value}`;}).join('\n');var reqData={eventType:_constants.NETWORKLOG,responseCode:error==null?void 0:(_error$response4=error.response)==null?void 0:_error$response4.status,requestMethod:error==null?void 0:(_error$response5=error.response)==null?void 0:(_error$response5$requ=_error$response5.request)==null?void 0:_error$response5$requ._method,requestUrl:error==null?void 0:(_error$response6=error.response)==null?void 0:(_error$response6$requ=_error$response6.request)==null?void 0:_error$response6$requ._url,requestType:logNetworkRequests(error==null?void 0:error.response),responseSize:`${responseSize.length} B`||`${error==null?void 0:(_error$response7=error.response)==null?void 0:(_error$response7$requ=_error$response7.request)==null?void 0:_error$response7$requ.responseHeaders["content-length"]} B`,responseTime:`${(_Object$values$2=Object.values(error==null?void 0:(_error$response$reque2=error.response.request)==null?void 0:(_error$response$reque3=_error$response$reque2._performanceLogger)==null?void 0:_error$response$reque3._timespans)[0])==null?void 0:_Object$values$2.totalTime}`,responseHeader:responseheaderfinal,requestHeader:reqheaderfinal,eventAt:`${eventAt}`,createdAt:Date.now(),response:`${JSON.stringify(error==null?void 0:(_error$response8=error.response)==null?void 0:_error$response8.data)||""}`,request:`${(error==null?void 0:(_error$response9=error.response)==null?void 0:(_error$response9$conf=_error$response9.config)==null?void 0:_error$response9$conf.data)||""}`};var req_body={message:{key:_Init.api_key,sdk_ver:_constants.SDK_VERSION,src:_constants.SRC,src_tech_stack:_constants.TECH_STACK,events:reqData,'eu_info_id':'N/A','eue_id':'0','euz_id':'0','ip':'','rel_ver':'N/A','timezone':'IST',s_id:`${sessionid}`,event_type:_constants.MESSAGE}};yield(0,_ApiCall.default)(reqData,req_body);});return function(_x2){return _ref6.apply(this,arguments);};}());return axiosInstance;};var _default=exports.default=AxiosInterceptor;