var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.Interceptor=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _Init=require("./Init");var _constants=require("../utils/constants");var _ApiCall=_interopRequireDefault(require("../utils/ApiCall"));var _asyncStorage=_interopRequireDefault(require("@react-native-async-storage/async-storage"));var _helper=require("../utils/helper");var _axios=_interopRequireDefault(require("axios"));var Interceptor=exports.Interceptor=function Interceptor(){var _data$data;if(_Init.data!=null&&(_data$data=_Init.data.data)!=null&&_data$data.network_capture){var originalFetch=fetch;fetch=function fetch(url,options){var _options$method;var requestMethod=(options==null?void 0:(_options$method=options.method)==null?void 0:_options$method.toUpperCase())||'GET';var start=new Date().getTime();return originalFetch.apply(this,arguments).then(function(){var _ref=(0,_asyncToGenerator2.default)(function*(response){var _response$headers2,_response$headers3,_response$_bodyBlob,_response$_bodyBlob$_;var end=new Date().getTime();if(response.url==='https://mobileservice.zipy.ai/post'){return response;}var logNetworkRequests=function logNetworkRequests(response){var _response$headers,_response$headers$map;var type='other';if(response.url.endsWith('.css')){type='css';}else if(response.url.endsWith('.js')){type='js';}else if(response.url.endsWith('.woff')||response.url.endsWith('.woff2')||response.url.endsWith('.ttf')){type='fonts';}else if(response.url.endsWith('.png')||response.url.endsWith('.jpg')||response.url.endsWith('.jpeg')||response.url.endsWith('.gif')){type='images';}else if(response!=null&&(_response$headers=response.headers)!=null&&(_response$headers$map=_response$headers.map['content-type'])!=null&&_response$headers$map.startsWith(_constants.CONTENT_TYPE)){type='xhr';}return type;};var method=(requestMethod==null?void 0:requestMethod.toLowerCase())||'';var eventAt=yield(0,_helper.formatTimestamp)(Date.now());var requestPayload=options==null?void 0:options.body;var reqType=logNetworkRequests(response);var reqResponse=null;try{reqResponse=yield response==null?void 0:response.json();}catch(error){}var originalObject=(response==null?void 0:(_response$headers2=response.headers)==null?void 0:_response$headers2.map)||(response==null?void 0:response.headers);var objectWithNewlines={};for(var key in originalObject){if(originalObject.hasOwnProperty(key)){objectWithNewlines[key]=originalObject[key]+"\n";}}var responseheaderfinal=Object.entries(objectWithNewlines).map(function(_ref2){var _ref3=(0,_slicedToArray2.default)(_ref2,2),key=_ref3[0],value=_ref3[1];return`${key}: ${value}`;}).join('\n');var requestheaderobject=options==null?void 0:options.headers;var requestheaderWithNewlines={};for(var _key in requestheaderobject){if(requestheaderobject.hasOwnProperty(_key)){requestheaderWithNewlines[_key]=requestheaderobject[_key]+"\n";}}var requestheaderfinal=Object.entries(requestheaderWithNewlines).map(function(_ref4){var _ref5=(0,_slicedToArray2.default)(_ref4,2),key=_ref5[0],value=_ref5[1];return`${key}: ${value}`;}).join('\n');var logData={eventType:_constants.NETWORKLOG,requestMethod:method||'',requestUrl:(response==null?void 0:response.url)||'',requestType:reqType||'',requestHeader:requestheaderfinal||'',responseCode:(response==null?void 0:response.status)||'',responseHeader:responseheaderfinal||'',responseTime:`${end-start}`,responseSize:`${(response==null?void 0:(_response$headers3=response.headers)==null?void 0:_response$headers3.get('content-length'))||(response==null?void 0:(_response$_bodyBlob=response._bodyBlob)==null?void 0:(_response$_bodyBlob$_=_response$_bodyBlob._data)==null?void 0:_response$_bodyBlob$_.size)} B`,eventAt:`${eventAt}`,request:`${requestPayload}`,createdAt:Date.now()};if(reqResponse!==null){logData.response=`${JSON.stringify(reqResponse)}`;}var sessionid=yield _asyncStorage.default.getItem('session_id');var req_body={message:{events:logData,'eu_info_id':'N/A','eue_id':'0','euz_id':'0','ip':'','rel_ver':'N/A','timezone':'IST',key:_Init.api_key,sdk_ver:_constants.SDK_VERSION,src:_constants.SRC,src_tech_stack:_constants.TECH_STACK,s_id:`${sessionid}`,event_type:_constants.MESSAGE}};yield(0,_ApiCall.default)(logData,req_body);return response.clone();});return function(_x){return _ref.apply(this,arguments);};}()).catch(function(error){console.error('[NETWORK INTERCEPTOR] fetch error:',error);throw error;});};}else{}};var _default=exports.default=Interceptor;